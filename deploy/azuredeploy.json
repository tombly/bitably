{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "nameEnvironment": {
            "type": "string",
            "metadata": {
                "description": "Used as part of the resource naming",
                "example": "dev, test, prod"
            }
        },
        "nameRegion": {
            "type": "string",
            "metadata": {
                "description": "Used as part of the resource naming",
                "example": "eus, eu2, uks"
            }
        },
        "nameApp": {
            "type": "string",
            "metadata": {
                "description": "Used as part of the resource naming",
                "example": "myapp, fitapp"
            }
        },
        "cdnEndpointName": {
            "type": "string",
            "metadata": {
                "description": "The subdomain of the CDN endpoint",
                "example": "myapp, fitapp"
            }
        },
        "rgLocation": {
            "type": "string",
            "metadata": {
                "description": "The region in which all resources are created",
                "example": "westus3, eastus, uksouth"
            }
        },
        "apimPublisherName": {
            "type": "string",
            "metadata": {
                "description": "Publisher info for the API management service",
                "example": "MyCorp"
            }
        },
        "apimPublisherEmail": {
            "type": "string",
            "metadata": {
                "description": "Publisher info for the API management service",
                "example": "jane@mycorp.com"
            }
        },
        "adTenantId": {
            "type": "string",
            "minLength": 36,
            "maxLength": 36,
            "metadata": {
                "description": "Azure Active Directory tenant ID to associate the key vault with",
                "example": "8082ee13-8438-437e-8568-f39cda6bf586"
            }
        }
    },
    "variables": {
        "safePrefix": "[concat(parameters('nameEnvironment'), parameters('nameRegion'), parameters('nameApp'))]",
        "dashPrefix": "[concat(parameters('nameEnvironment'), '-', parameters('nameRegion'), '-', parameters('nameApp'), '-')]",
        "rgName": "[concat(variables('dashPrefix'), 'rg')]",

        "containersName": "[concat(variables('safePrefix'), 'containers')]",
        "storageDataAccountName": "[concat(variables('safePrefix'), 'datastorage')]",
        "storageSiteAccountName": "[concat(variables('safePrefix'), 'sitestorage')]",
        "storageFuncAccountName": "[concat(variables('safePrefix'), 'funcstorage')]",
        "cosmosAccountName": "[concat(variables('dashPrefix'), 'cosmosdb')]",
        "appName": "[concat(variables('safePrefix'), 'api')]",
        "appInsightsName": "[concat(variables('dashPrefix'), 'appinsights')]",
        "aspName": "[concat(variables('dashPrefix'), 'asp')]",
        "cdnName": "[concat(variables('dashPrefix'), 'cdn')]",
        "fetchFunctionName": "[concat(variables('dashPrefix'), 'fetchfunc')]",
        "apimName": "[concat(variables('dashPrefix'), 'apim')]",
        "appConfigName": "[concat(variables('dashPrefix'), 'appconfig')]",
        "keyVaultName": "[concat(variables('dashPrefix'), 'keyvault')]",

        "apimApiName": "BitablyAPI",
        "apimFunctionName": "FetchFunctionAPI"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2018-05-01",
            "location": "[parameters('rgLocation')]",
            "name": "[variables('rgName')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "appInsightsDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[variables('rgName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "appInsightsName": {
                        "value": "[variables('appInsightsName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "appInsightsName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "microsoft.insights/components",
                            "apiVersion": "2015-05-01",
                            "name": "[parameters('appInsightsName')]",
                            "location": "[parameters('rgLocation')]",
                            "tags": {},
                            "kind": "other",
                            "properties": {
                                "Application_Type": "web",
                                "ApplicationId": "[parameters('appInsightsName')]"
                            }
                        }
                    ]
                },
                "outputs": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "configDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[variables('rgName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "appConfigName": {
                        "value": "[variables('appConfigName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "appConfigName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.AppConfiguration/configurationStores",
                            "apiVersion": "2021-10-01-preview",
                            "name": "[parameters('appConfigName')]",
                            "location": "[parameters('rgLocation')]",
                            "sku": {
                                "name": "free"
                            },
                            "properties": {
                                "encryption": {},
                                "disableLocalAuth": false,
                                "softDeleteRetentionInDays": 0,
                                "enablePurgeProtection": false
                            }
                        }
                    ]
                },
                "outputs": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "vaultDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[variables('rgName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "keyVaultName": {
                        "value": "[variables('keyVaultName')]"
                    },
                    "tenantId": {
                        "value": "[parameters('adTenantId')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "keyVaultName": {
                            "type": "string"
                        },
                        "tenantId": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.KeyVault/vaults",
                            "apiVersion": "2021-11-01-preview",
                            "name": "[parameters('keyVaultName')]",
                            "location": "[parameters('rgLocation')]",
                            "properties": {
                                "sku": {
                                    "family": "A",
                                    "name": "Standard"
                                },
                                "tenantId": "[parameters('tenantId')]",
                                "accessPolicies": [],
                                "enableSoftDelete": false,
                                "enableRbacAuthorization": false,
                                "vaultUri": "[concat('https://', parameters('keyVaultName'), '.vault.azure.net/')]",
                                "publicNetworkAccess": "Enabled"
                            }
                        }
                    ]
                },
                "outputs": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "registryDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[variables('rgName')]",
                "appServiceDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "containersName": {
                        "value": "[variables('containersName')]"
                    },
                    "appName": {
                        "value": "[variables('appName')]"
                    },
                    "rgName": {
                        "value": "[variables('rgName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "containersName": {
                            "type": "string"
                        },
                        "appName": {
                            "type": "string"
                        },
                        "rgName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.ContainerRegistry/registries",
                            "apiVersion": "2021-06-01-preview",
                            "name": "[parameters('containersName')]",
                            "location": "[parameters('rgLocation')]",
                            "tags": {},
                            "sku": {
                                "name": "Basic",
                                "tier": "Basic"
                            },
                            "properties": {
                                "adminUserEnabled": true,
                                "policies": {
                                    "quarantinePolicy": {
                                        "status": "disabled"
                                    },
                                    "trustPolicy": {
                                        "type": "Notary",
                                        "status": "disabled"
                                    },
                                    "retentionPolicy": {
                                        "days": 7,
                                        "status": "disabled"
                                    },
                                    "exportPolicy": {
                                        "status": "enabled"
                                    }
                                },
                                "encryption": {
                                    "status": "disabled"
                                },
                                "dataEndpointEnabled": false,
                                "publicNetworkAccess": "Enabled",
                                "networkRuleBypassOptions": "AzureServices",
                                "zoneRedundancy": "Disabled",
                                "anonymousPullEnabled": false
                            }
                        },
                        {
                            "type": "Microsoft.ContainerRegistry/registries/webhooks",
                            "apiVersion": "2021-06-01-preview",
                            "name": "[concat(parameters('containersName'), '/', parameters('appName'))]",
                            "location": "[parameters('rgLocation')]",
                            "dependsOn": [
                                "[parameters('containersName')]"
                            ],
                            "properties": {
                                "status": "enabled",
                                "scope": "bitably-api:latest",
                                "actions": [
                                    "push"
                                ],
                                "serviceUri": "[concat(list(resourceId(parameters('rgName'), 'Microsoft.Web/sites/config', parameters('appName'), 'publishingcredentials'), '2015-08-01').properties.scmUri, '/docker/hook')]"
                            }
                        }
                    ]
                },
                "outputs": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "storageDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2017-10-01",
                            "name": "[variables('storageDataAccountName')]",
                            "location": "[parameters('rgLocation')]",
                            "kind": "StorageV2",
                            "sku": {
                                "name": "Standard_LRS"
                            }
                        }
                    ],
                    "outputs": {}
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "cosmosDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.DocumentDB/databaseAccounts",
                            "apiVersion": "2021-04-15",
                            "name": "[variables('cosmosAccountName')]",
                            "location": "[parameters('rgLocation')]",
                            "properties": {
                                "enableFreeTier": true,
                                "databaseAccountOfferType": "Standard",
                                "consistencyPolicy": {
                                    "defaultConsistencyLevel": "Session"
                                },
                                "locations": [
                                    {
                                        "locationName": "[parameters('rgLocation')]"
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "appServiceDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]",
                "appInsightsDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "appName": {
                        "value": "[variables('appName')]"
                    },
                    "aspName": {
                        "value": "[variables('aspName')]"
                    },
                    "containersName": {
                        "value": "[variables('containersName')]"
                    },
                    "appInsightsName": {
                        "value": "[variables('appInsightsName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "appName": {
                            "type": "string"
                        },
                        "aspName": {
                            "type": "string"
                        },
                        "containersName": {
                            "type": "string"
                        },
                        "appInsightsName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Web/serverfarms",
                            "apiVersion": "2021-01-15",
                            "name": "[parameters('aspName')]",
                            "location": "[parameters('rgLocation')]",
                            "sku": {
                                "name": "B1"
                            },
                            "kind": "linux",
                            "properties": {
                                "reserved": true
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites",
                            "apiVersion": "2021-01-15",
                            "name": "[parameters('appName')]",
                            "location": "[parameters('rgLocation')]",
                            "dependsOn": [
                                "[parameters('aspName')]"
                            ],
                            "properties": {
                                "serverFarmId": "[parameters('aspName')]",
                                "siteConfig": {
                                    "linuxFxVersion": "[concat('DOCKER|',parameters('containersName'),'.azurecr.io/bitably-api:latest')]",
                                    "acrUseManagedIdentityCreds": false,
                                    "appSettings": [
                                        {
                                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                                            "value": "[reference(concat('microsoft.insights/components/',parameters('appInsightsName')), '2015-05-01').InstrumentationKey]"
                                        },
                                        {
                                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                                            "value": "[reference(concat('microsoft.insights/components/',parameters('appInsightsName')), '2015-05-01').ConnectionString]"
                                        },
                                        {
                                            "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                                            "value": "~2"
                                        },
                                        {
                                            "name": "XDT_MicrosoftApplicationInsights_Mode",
                                            "value": "default"
                                        },
                                        {
                                            "name": "DOCKER_ENABLE_CI",
                                            "value": "true"
                                        }
                                    ]
                                },
                                "resources": []
                            }
                        },                       
                        {
                            "type": "Microsoft.Web/sites/config",
                            "apiVersion": "2021-03-01",
                            "name": "[concat(parameters('appName'), '/web')]",
                            "location": "[parameters('rgLocation')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Web/sites', parameters('appName'))]"
                            ],
                            "properties": {
                                "httpLoggingEnabled": true,
                                "logsDirectorySizeLimit": 35
                            }
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "apimDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "apimName": {
                        "value": "[variables('apimName')]"
                    },
                    "apimPublisherEmail": {
                        "value": "[parameters('apimPublisherEmail')]"
                    },
                    "apimPublisherName": {
                        "value": "[parameters('apimPublisherName')]"
                    },
                    "apimApiName": {
                        "value": "[variables('apimApiName')]"
                    },
                    "appName": {
                        "value": "[variables('appName')]"
                    },
                    "apimFunctionName": {
                        "value": "[variables('apimFunctionName')]"
                    },
                    "fetchFunctionName": {
                        "value": "[variables('fetchFunctionName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "apimName": {
                            "type": "string"
                        },
                        "apimPublisherEmail": {
                            "type": "string"
                        },
                        "apimPublisherName": {
                            "type": "string"
                        },
                        "apimApiName": {
                            "type": "string"
                        },
                        "appName": {
                            "type": "string"
                        },
                        "apimFunctionName": {
                            "type": "string"
                        },
                        "fetchFunctionName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.ApiManagement/service",
                            "apiVersion": "2019-12-01",
                            "name": "[parameters('apimName')]",
                            "location": "[parameters('rgLocation')]",
                            "sku": {
                                "name": "Consumption",
                                "capacity": "0"
                            },
                            "properties": {
                                "publisherEmail": "[parameters('apimPublisherEmail')]",
                                "publisherName": "[parameters('apimPublisherName')]"
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/bitably')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "[parameters('apimApiName')]",
                                "apiRevision": "1",
                                "subscriptionRequired": false,
                                "serviceUrl": "[concat('https://',parameters('appName'),'.azurewebsites.net')]",
                                "protocols": [
                                    "https"
                                ],
                                "isCurrent": true,
                                "path": "/"
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/fetchfunction')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "[parameters('apimFunctionName')]",
                                "apiRevision": "1",
                                "subscriptionRequired": false,
                                "serviceUrl": "[concat('https://',parameters('fetchFunctionName'),'.azurewebsites.net/api/orchestrators/FetchOrchestrator')]",
                                "path": "fetch",
                                "protocols": [
                                    "https"
                                ],
                                "isCurrent": true
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis/operations",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/bitably/register')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'bitably')]",
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "Register",
                                "method": "GET",
                                "urlTemplate": "/register",
                                "templateParameters": [],
                                "request": {
                                    "queryParameters": [
                                        {
                                            "name": "userId",
                                            "values": [],
                                            "type": null
                                        },
                                        {
                                            "name": "token",
                                            "values": [],
                                            "type": null
                                        }
                                    ],
                                    "headers": [],
                                    "representations": []
                                },
                                "responses": []
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis/operations",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/bitably/sleep-day-count')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'bitably')]",
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "Sleep Day Count",
                                "method": "GET",
                                "urlTemplate": "/sleep/days/count",
                                "templateParameters": [],
                                "request": {
                                    "queryParameters": [
                                        {
                                            "name": "userId",
                                            "values": [],
                                            "type": null
                                        }
                                    ],
                                    "headers": [],
                                    "representations": []
                                },
                                "responses": []
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis/operations",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/bitably/sleep-day-hours-streak')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'bitably')]",
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "Sleep Day Hours Streak",
                                "method": "GET",
                                "urlTemplate": "/sleep/days/hourstreak",
                                "templateParameters": [],
                                "request": {
                                    "queryParameters": [
                                        {
                                            "name": "userId",
                                            "values": [],
                                            "type": null
                                        }
                                    ],
                                    "headers": [],
                                    "representations": []
                                },
                                "responses": []
                            }
                        },
                        {
                            "type": "Microsoft.ApiManagement/service/apis/operations",
                            "apiVersion": "2021-01-01-preview",
                            "name": "[concat(parameters('apimName'),'/fetchfunction/fetch')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'fetchfunction')]",
                                "[resourceId('Microsoft.ApiManagement/service', parameters('apimName'))]"
                            ],
                            "properties": {
                                "displayName": "Fetch",
                                "method": "GET",
                                "urlTemplate": "/",
                                "templateParameters": [],
                                "responses": []
                            }
                        }
                    ],
                    "outputs": {}
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "functionDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]",
                "appInsightsDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "storageFuncAccountName": {
                        "value": "[variables('storageFuncAccountName')]"
                    },
                    "appInsightsName": {
                        "value": "[variables('appInsightsName')]"
                    },
                    "fetchFunctionName": {
                        "value": "[variables('fetchFunctionName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "storageFuncAccountName": {
                            "type": "string"
                        },
                        "appInsightsName": {
                            "type": "string"
                        },
                        "fetchFunctionName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2017-10-01",
                            "name": "[parameters('storageFuncAccountName')]",
                            "location": "[parameters('rgLocation')]",
                            "kind": "StorageV2",
                            "sku": {
                                "name": "Standard_LRS"
                            }
                        },                       
                        {
                            "apiVersion": "2015-08-01",
                            "type": "Microsoft.Web/sites",
                            "name": "[parameters('fetchFunctionName')]",
                            "location": "[resourceGroup().location]",
                            "kind": "functionapp",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageFuncAccountName'))]"
                            ],
                            "properties": {
                                "siteConfig": {
                                    "appSettings": [
                                        {
                                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                                            "value": "[reference(concat('microsoft.insights/components/',parameters('appInsightsName')), '2015-05-01').InstrumentationKey]"
                                        },
                                        {
                                            "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                                            "value": "[reference(concat('microsoft.insights/components/',parameters('appInsightsName')), '2015-05-01').ConnectionString]"
                                        },
                                        {
                                            "name": "AzureWebJobsStorage",
                                            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageFuncAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageFuncAccountName')),'2019-06-01').keys[0].value)]"
                                        },
                                        {
                                            "name": "FUNCTIONS_WORKER_RUNTIME",
                                            "value": "node"
                                        },
                                        {
                                            "name": "WEBSITE_NODE_DEFAULT_VERSION",
                                            "value": "10.14.1"
                                        },
                                        {
                                            "name": "FUNCTIONS_EXTENSION_VERSION",
                                            "value": "~3"
                                        }
                                    ]
                                }
                            }
                        }
                    ],
                    "outputs": {}
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "siteDeployment",
            "resourceGroup": "[variables('rgName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "rgLocation": {
                        "value": "[parameters('rgLocation')]"
                    },
                    "storageSiteAccountName": {
                        "value": "[variables('storageSiteAccountName')]"
                    },
                    "cdnName": {
                        "value": "[variables('cdnName')]"
                    },
                    "cdnEndpointName": {
                        "value": "[parameters('cdnEndpointName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "rgLocation": {
                            "type": "string"
                        },
                        "storageSiteAccountName": {
                            "type": "string"
                        },
                        "cdnName": {
                            "type": "string"
                        },
                        "cdnEndpointName": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2019-06-01",
                            "name": "[parameters('storageSiteAccountName')]",
                            "location": "[parameters('rgLocation')]",
                            "sku": {
                                "name": "Standard_LRS",
                                "tier": "Standard"
                            },
                            "kind": "StorageV2",
                            "properties": {
                                "accessTier": "Hot"
                            },
                            "resources": [
                                {
                                    "type": "blobServices/containers",
                                    "apiVersion": "2019-06-01",
                                    "name": "default/$web",
                                    "dependsOn": [
                                        "[parameters('storageSiteAccountName')]"
                                    ]
                                }
                            ]
                        },
                        {
                            "type": "Microsoft.Cdn/profiles",
                            "apiVersion": "2020-04-15",
                            "name": "[parameters('cdnName')]",
                            "location": "global",
                            "sku": {
                                "name": "Standard_Microsoft"
                            },
                            "properties": {}
                        },
                        {
                            "type": "Microsoft.Cdn/profiles/endpoints",
                            "apiVersion": "2020-04-15",
                            "name": "[concat(parameters('cdnName'), '/', parameters('cdnEndpointName'))]",
                            "location": "global",
                            "dependsOn": [
                                "[parameters('cdnName')]",
                                "[parameters('storageSiteAccountName')]"
                            ],
                            "properties": {
                                "queryStringCachingBehavior": "BypassCaching",
                                "originHostHeader": "[replace(replace(reference(concat('Microsoft.Storage/storageAccounts/', parameters('storageSiteAccountName')), '2019-06-01', 'Full').properties.primaryEndpoints.web,'https://',''),'/','')]",
                                "origins": [
                                    {
                                        "name": "origin1",
                                        "properties": {
                                            "hostName": "[replace(replace(reference(concat('Microsoft.Storage/storageAccounts/', parameters('storageSiteAccountName')), '2019-06-01', 'Full').properties.primaryEndpoints.web,'https://',''),'/','')]"
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        }        
    ]
}
